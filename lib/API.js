// Generated by CoffeeScript 1.7.1
(function() {
  var API, Serializer, append_slash, callable, debug, querystring, request, _ref,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  querystring = require('querystring');

  debug = require('debug')('slumber:api');

  _ref = require('./utils'), callable = _ref.callable, append_slash = _ref.append_slash;

  request = require('request');

  Serializer = require('./Serializer').Serializer;

  API = callable((function() {
    function _Class(base_url, opts, fn) {
      var _base, _base1, _base2, _base3, _base4;
      this.opts = opts != null ? opts : {};
      if (fn == null) {
        fn = null;
      }
      this.patch = __bind(this.patch, this);
      this.put = __bind(this.put, this);
      this.post = __bind(this.post, this);
      this["delete"] = __bind(this["delete"], this);
      this.get = __bind(this.get, this);
      this.wrap_response = __bind(this.wrap_response, this);
      this._prepare_opts = __bind(this._prepare_opts, this);
      this._request = __bind(this._request, this);
      this._try_to_serialize = __bind(this._try_to_serialize, this);
      this._create_child = __bind(this._create_child, this);
      if (base_url != null) {
        this.opts.base_url = base_url;
      }
      if ((_base = this.opts).append_slash == null) {
        _base.append_slash = true;
      }
      if ((_base1 = this.opts).auth == null) {
        _base1.auth = null;
      }
      if ((_base2 = this.opts).request_opts == null) {
        _base2.request_opts = {
          rejectUnauthorized: false
        };
      }
      if ((_base3 = this.opts).format == null) {
        _base3.format = 'json';
      }
      this.serializer = (_base4 = this.opts).serializer != null ? _base4.serializer : _base4.serializer = new Serializer(this.opts.format);
      if (this.opts.append_slash) {
        this.opts.base_url = append_slash(this.opts.base_url);
      }
      this.base_url = this.opts.base_url;
      if (!this.opts.base_url) {
        throw "base_url is required";
      }
      process.nextTick(function() {
        if (fn) {
          return fn(this);
        }
      });
      return this;
    }

    _Class.prototype._create_child = function(path) {
      var callable_api, child, new_base_url;
      new_base_url = "" + (append_slash(this.base_url)) + path;
      callable_api = API;
      child = new callable_api(new_base_url, this.opts);
      return child;
    };

    _Class.prototype._try_to_serialize = function(response, body) {
      var content_type, e, stype;
      if (response.headers['content-type'] != null) {
        content_type = response.headers['content-type'].split(';')[0].replace(/^\s*|\s*$/g, '');
        try {
          stype = this.serializer.get_serializer(null, content_type);
        } catch (_error) {
          e = _error;
          return body;
        }
        return stype.loads(body);
      }
      return body;
    };

    _Class.prototype._request = function(method, kwargs, fn) {
      var key, req, request_options, value, _ref1;
      request_options = {
        url: this.base_url,
        method: method,
        headers: {
          accept: this.serializer.get_serializer().get_content_type()
        }
      };
      _ref1 = this.opts.request_opts;
      for (key in _ref1) {
        value = _ref1[key];
        if (request_options[key] == null) {
          request_options[key] = value;
        }
      }
      if (kwargs.args != null) {
        request_options.url += '?' + querystring.stringify(kwargs.args);
      }
      if (kwargs.data != null) {
        request_options.form = kwargs.data;
      }
      if (this.opts.auth) {
        request_options.auth = {
          user: this.opts.auth[0],
          pass: this.opts.auth[1],
          sentImmediately: true
        };
      }
      if (this.opts.proxy) {
        request_options.proxy = opts.proxy;
      }
      debug("" + method, request_options.url);
      return req = request(request_options, fn);
    };

    _Class.prototype.callable = _Class.prototype._create_child;

    _Class.prototype._prepare_opts = function(from, default_dest) {
      var k, key, section, to, translation, v, value;
      if (default_dest == null) {
        default_dest = 'args';
      }
      to = {
        args: {},
        data: {}
      };
      translation = {
        query: 'args'
      };
      for (key in from) {
        value = from[key];
        if (key.slice(0, 2) === '__') {
          section = key.slice(2);
          if (translation[section] != null) {
            section = translation[section];
          }
          for (k in value) {
            v = value[k];
            to[section][k] = v;
          }
        } else {
          to[default_dest][key] = value;
        }
      }
      return to;
    };

    _Class.prototype.wrap_response = function(fn, err, response, ret) {
      switch (fn.length) {
        case 1:
          return fn(ret);
        case 2:
          return fn(err, ret);
        case 3:
          return fn(err, response, ret);
      }
    };

    _Class.prototype.get = function(query, fn) {
      var handle, opts, resp;
      if ('function' === typeof query) {
        fn = query;
        query = {};
      }
      opts = this._prepare_opts(query, 'args');
      handle = (function(_this) {
        return function(err, response, body) {
          var _ref1;
          if ((200 <= (_ref1 = response.statusCode) && _ref1 <= 299)) {
            return _this.wrap_response(fn, err, response, _this._try_to_serialize(response, body));
          } else if (response != null ? response.statusCode : void 0) {
            return _this.wrap_response(fn, {
              "statusCode": response.statusCode
            }, response, null);
          } else {
            return _this.wrap_response(fn, true, response, null);
          }
        };
      })(this);
      return resp = this._request('GET', opts, handle);
    };

    _Class.prototype["delete"] = function(query, fn) {
      var handle, opts, resp;
      if ('function' === typeof query) {
        fn = query;
        query = {};
      }
      opts = this._prepare_opts(query, 'args');
      handle = (function(_this) {
        return function(err, response, body) {
          var _ref1;
          if ((200 <= (_ref1 = response.statusCode) && _ref1 <= 299)) {
            if (response.statusCode === 204) {
              return _this.wrap_response(fn, err, response, true);
            } else {
              return _this.wrap_response(fn, err, response, true);
            }
          } else {
            return _this.wrap_reponse(fn, true, response, false);
          }
        };
      })(this);
      return resp = this._request('DELETE', opts, handle);
    };

    _Class.prototype.post = function(data, fn) {
      var handle, opts, resp;
      opts = this._prepare_opts(data, 'data');
      handle = (function(_this) {
        return function(err, response, body) {
          var _ref1;
          if ((200 <= (_ref1 = response.statusCode) && _ref1 <= 299)) {
            return _this.wrap_response(fn, err, response, _this._try_to_serialize(response, body));
          }
          return _this.wrap_response(fn, err, response, true);
        };
      })(this);
      return resp = this._request('POST', opts, handle);
    };

    _Class.prototype.put = function(data, fn) {
      var handle, opts, resp;
      opts = this._prepare_opts(data, 'data');
      handle = (function(_this) {
        return function(err, response, body) {
          var _ref1;
          if ((200 <= (_ref1 = response.statusCode) && _ref1 <= 299)) {
            return _this.wrap_response(fn, err, response, _this._try_to_serialize(response, body));
          }
          return _this.wrap_response(fn, true, response, null);
        };
      })(this);
      return resp = this._request('PUT', opts, handle);
    };

    _Class.prototype.patch = function(data, fn) {
      var handle, opts, resp;
      opts = this._prepare_opts(data, 'data');
      handle = (function(_this) {
        return function(err, response, body) {
          var _ref1;
          if ((200 <= (_ref1 = response.statusCode) && _ref1 <= 299)) {
            return _this.wrap_response(fn, err, response, _this._try_to_serialize(response, body));
          }
          return _this.wrap_response(fn, err, response, true);
        };
      })(this);
      return resp = this._request('PATCH', opts, handle);
    };

    return _Class;

  })());

  module.exports = API;

}).call(this);
